<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vietnamese Learning Adventures - Conditional Map Access</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <style>
        /* Custom font */
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
            display: flex; 
            flex-direction: column;
            height: 100vh;
            background-color: #f9fafb; 
        }
        html, body {
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }

        /* Page Content Area */
        #page-content-area {
            flex-grow: 1; 
            position: relative; 
            overflow: hidden; 
        }
        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none; 
            flex-direction: column; 
            background-color: #f9fafb; 
            overflow-y: auto;
            padding-bottom: 76px; /* 60px for nav + 16px for breathing room */
            box-sizing: border-box; /* Ensure padding is included in height calculation */
        }
        .page.active-page {
            display: flex; 
        }
        
        #map-page-content {
            overflow: hidden;
            padding-bottom: 0; /* Map page doesn't need this padding, its content is fixed height */
        }
      
        /* Stories Page Specific Styles */
        #stories-page-content {
            /* overflow-y: auto; already on .page */
        }

        .stories-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr)); 
            gap: 1rem; 
            padding: 1rem; 
            padding-bottom: 2rem; /* Add padding at the bottom if load more is removed */
        }
        .story-card {
            position: relative;
            border-radius: 0.75rem; 
            overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06); 
            aspect-ratio: 3 / 4; 
            cursor: pointer;
        }
        .story-card-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            z-index: 1;
        }
        .story-card-overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: auto; 
            min-height: 40%; 
            background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.7) 50%, rgba(0,0,0,0) 100%);
            z-index: 2;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 0.75rem; 
        }
         .story-card .card-title {
            font-size: 1.25rem; 
            font-weight: 700; 
            color: white;
            margin-bottom: 0.125rem; 
        }
        .story-card .card-subtitle {
            font-size: 0.75rem; 
            color: #E5E7EB; 
            margin-bottom: 0.25rem; 
        }
        .story-card .card-episodes-text { 
            font-size: 0.75rem; 
            color: #D1D5DB; 
            margin-bottom: 0.5rem; 
        }
        .progress-bar-container {
            width: 100%;
            height: 6px; 
            background-color: rgba(255, 255, 255, 0.3); 
            border-radius: 3px; 
            overflow: hidden;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: #FACC15; 
            border-radius: 3px;
            transition: width 0.5s ease-in-out;
        }

        #lessons-page-content .content-padding,
        #profile-page-content .content-padding {
             padding: 2rem; 
        }

        #map-container {
            width: 100%;
            height: 100%; 
            z-index: 1;
        }
        #map {
            height: 100%;
            width: 100%;
        }
        #info-panel {
            position: fixed; 
            bottom: 60px; 
            left: 0;
            right: 0;
            width: 100%;
            background-color: white;
            box-shadow: 0 -4px 12px rgba(0,0,0,0.15);
            border-top-left-radius: 1.5rem;
            border-top-right-radius: 1.5rem;
            display: flex;
            flex-direction: column; 
            height: 60vh; 
            transform: translateY(100%);  
            transition: transform 0.3s ease-in-out, height 0.3s ease-in-out;
            z-index: 1000;
        }
        #info-panel.expanded { transform: translateY(0); height: 60vh; }
        #info-panel.collapsed { transform: translateY(0); height: 80px; }
        #info-panel.hidden-fully { transform: translateY(100%); }
        #info-panel.collapsed #info-content-wrapper,
        #info-panel.collapsed #info-panel-navigation { display: none; }
        #info-panel.collapsed #info-panel-header { border-bottom: none; }

        .custom-marker-icon { 
            color: white; border-radius: 50%; text-align: center; font-weight: bold;
            border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: width 0.15s ease-in-out, height 0.15s ease-in-out, line-height 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        }
        .custom-marker-icon.status-locked-upcoming { background-color: #3B82F6; }
        .custom-marker-icon.status-current { background-color: #10B981; animation: pulse-current 2s infinite; }
        .custom-marker-icon.status-completed-base { background-color: #047857; }
        .custom-marker-icon.status-completed-bronze { background-color: #D97706; }
        .custom-marker-icon.status-completed-silver { background-color: #94A3B8; }
        .custom-marker-icon.status-completed-gold { background-color: #FACC15; color: #422006; }
        
        @keyframes pulse-current {
            0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7), 0 2px 5px rgba(0,0,0,0.3); }
            70% { box-shadow: 0 0 0 10px rgba(16, 185, 129, 0), 0 2px 5px rgba(0,0,0,0.3); }
            100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0), 0 2px 5px rgba(0,0,0,0.3); }
        }

        #info-panel-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.75rem 1.5rem; border-bottom: 1px solid #e5e7eb;
            flex-shrink: 0; cursor: pointer; 
        }
        #panel-title { min-width: 0; }
        #close-panel-btn { padding: 0.25rem; }
        #drag-handle {
            width: 40px; height: 4px; background-color: #D1D5DB;
            border-radius: 2px; margin: 0.5rem auto 0.25rem; flex-shrink: 0;
            cursor: pointer; 
        }
        #info-panel-navigation {
            display: flex; justify-content: space-between; align-items: center;
            padding: 0.5rem 1.5rem; border-bottom: 1px solid #e5e7eb; flex-shrink: 0; 
        }
        #info-panel-navigation button:disabled { opacity: 0.5; cursor: not-allowed; }
        #info-panel-navigation button:disabled svg { color: #9CA3AF; }

        #info-content-wrapper {
            flex-grow: 1; overflow-y: auto; padding: 0 1.5rem 1.5rem;
            -webkit-overflow-scrolling: touch; display: block; 
        }
        #info-content img { 
            height: 160px; margin-bottom: 1rem; transition: filter 0.3s ease-in-out;
        }
        #info-content img.grayscale { filter: grayscale(100%); }
        .key-phrases-title {
            font-weight: 600; color: #374151; margin-top: 0.75rem; margin-bottom: 0.25rem;
        }
        .key-phrases-list {
            list-style-type: disc; margin-left: 1.25rem; font-size: 0.875rem; color: #4B5563; 
        }
        .scenario-description {
            font-size: 0.875rem; color: #4B5563; margin-top: 0.5rem; line-height: 1.6;
        }
        
        .status-indicator-container {
            display: flex; justify-content: center; align-items: center;
            margin-top: 0.75rem; margin-bottom: 1rem; 
        }
        .status-indicator-container svg { 
            width: 1.75rem; height: 1.75rem; margin-right: 0.25rem; 
        }
        .status-indicator-container svg:last-child { margin-right: 0; }
        .star-filled { color: #FACC15; }
        .star-empty { color: #D1D5DB; }
        .lock-icon { color: #6B7280; width: 2rem !important; height: 2rem !important; }

        .start-lesson-button {
            background-color: #10B981; color: white; font-weight: 600; 
            padding: 0.75rem 1.5rem; border-radius: 0.5rem; 
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); 
            transition: background-color 0.2s ease-in-out;
        }
        .start-lesson-button:hover { background-color: #059669; }

        #bottom-nav {
            width: 100%; height: 60px; background-color: white;
            border-top: 1px solid #e5e7eb; display: flex;
            justify-content: space-around; align-items: center;
            position: fixed; bottom: 0; left: 0;
            z-index: 1100; flex-shrink: 0;
        }
        .nav-item {
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; flex-grow: 1; padding: 0.5rem 0;
            font-size: 0.75rem; color: #6B7280; cursor: pointer;
            transition: color 0.2s ease-in-out;
        }
        .nav-item:hover { color: #10B981; }
        .nav-item.active-nav-item { color: #10B981; font-weight: 600; }
        .nav-item.nav-item-disabled { /* New style for disabled nav items */
            color: #D1D5DB; /* Tailwind gray-300 */
            cursor: not-allowed;
            pointer-events: none; /* Prevents click */
        }
        .nav-item.nav-item-disabled:hover {
            color: #D1D5DB; /* Keep it gray on hover */
        }
        .nav-item svg { width: 1.5rem; height: 1.5rem; margin-bottom: 0.25rem; }

    </style>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="page-content-area">
        <div id="stories-page-content" class="page active-page">
            <div class="stories-grid" id="stories-grid-container">
                </div>
            </div>

        <div id="map-page-content" class="page">
            <div id="map-container">
                <div id="map"></div>
            </div>
        </div>
        <div id="profile-page-content" class="page">
            <div class="content-padding">
                <h1 class="text-2xl font-bold text-gray-800">User Profile</h1>
                <p class="mt-4 text-gray-600">User settings and profile information will go here.</p>
            </div>
        </div>
    </div>

    <div id="info-panel"> 
        <div id="drag-handle"></div>
        <div id="info-panel-header">
            <h2 id="panel-title" class="text-xl font-bold text-gray-800 truncate">Scenario Details</h2>
            <button id="close-panel-btn" class="text-gray-500 hover:text-gray-700">
                </button>
        </div>
        <div id="info-panel-navigation">
            <button id="prev-location-btn" class="p-2 rounded-full hover:bg-gray-100 active:bg-gray-200">
                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <span id="current-location-indicator" class="text-sm font-medium text-gray-600"></span>
            <button id="next-location-btn" class="p-2 rounded-full hover:bg-gray-100 active:bg-gray-200">
                <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        </div>
        <div id="info-content-wrapper">
            <div id="info-content">
                 <p class="text-gray-600">Select a scenario marker to begin learning!</p>
            </div>
        </div>
    </div>

    <nav id="bottom-nav">
        <div class="nav-item active-nav-item" data-page="stories-page-content"> 
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" /></svg> <span>Stories</span>
        </div>
        <div class="nav-item" data-page="map-page-content"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 6.75V15m6-6v8.25m.503-8.495l4.875-2.178A.75.75 0 0121 7.22v10.582a.75.75 0 01-1.125.658l-4.875-2.178a.75.75 0 010-1.316l4.875-2.178a.75.75 0 011.125.658zM9 6.75h.008v.008H9V6.75zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zM15 8.25h.008v.008H15V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" /></svg>
            <span>Map</span>
        </div>
        <div class="nav-item" data-page="profile-page-content">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0zM4.501 20.118a7.5 7.5 0 0114.998 0A17.933 17.933 0 0112 21.75c-2.676 0-5.216-.584-7.499-1.632z" /></svg>
            <span>Profile</span>
        </div>
    </nav>


    <script>
        // Define Alexa's lessons (North to Central) - 10 Episodes
        const alexaStoryLessons = [
            { id: 'alexa_ep1', coords: [21.2212, 105.8040], scenarioTitle: "Airport Arrival & Taxi", learningFocus: "Customs, taxi, directions.", keyPhrases: ["Xin chào", "Taxi ở đâu?", "Đến khách sạn này.", "Bao nhiêu tiền?"], dialoguePrompt: "Navigate immigration and find a taxi.", imageUrl: "https://placehold.co/600x400/87CEEB/FFF?text=Noi+Bai+Airport", status: 'current', performance: null },
            { id: 'alexa_ep2', coords: [21.0338, 105.8522], scenarioTitle: "First Bowl of Phở", learningFocus: "Ordering food, menu items.", keyPhrases: ["Cho tôi một bát phở bò.", "Không hành.", "Ngon quá!", "Tính tiền."], dialoguePrompt: "Order Phở at a street stall.", imageUrl: "https://placehold.co/600x400/FFD700/000?text=Hanoi+Pho", status: 'locked', performance: null },
            { id: 'alexa_ep3', coords: [21.0288, 105.8358], scenarioTitle: "Cultural Visit (Temple of Lit.)", learningFocus: "Info, opening hours, tickets.", keyPhrases: ["Vé vào cổng?", "Mở cửa lúc mấy giờ?", "Chụp ảnh được không?"], dialoguePrompt: "Visit Temple of Literature.", imageUrl: "https://placehold.co/600x400/3CB371/FFF?text=Temple+Lit", status: 'locked', performance: null },
            { id: 'alexa_ep4', coords: [20.9101, 107.1839], scenarioTitle: "Ha Long Bay Cruise", learningFocus: "Booking cruise, activities.", keyPhrases: ["Tour đi Vịnh Hạ Long?", "Có kayak không?", "Ngắm hoàng hôn."], dialoguePrompt: "Inquire about a Ha Long Bay day cruise.", imageUrl: "https://placehold.co/600x400/4682B4/FFF?text=Ha+Long+Cruise", status: 'locked', performance: null },
            { id: 'alexa_ep5', coords: [16.4637, 107.5909], scenarioTitle: "City Tour by Cyclo (Hue)", learningFocus: "Negotiating price, directions.", keyPhrases: ["Đi một vòng thành phố?", "Giá bao nhiêu?", "Đến cầu Tràng Tiền."], dialoguePrompt: "Negotiate a cyclo tour in Hue.", imageUrl: "https://placehold.co/600x400/FFA07A/000?text=Hue+Cyclo", status: 'locked', performance: null },
            { id: 'alexa_ep6', coords: [16.4720, 107.5870], scenarioTitle: "Shopping at Dong Ba Market (Hue)", learningFocus: "Bargaining, finding items.", keyPhrases: ["Nón lá này đẹp quá!", "Bớt một chút được không?", "Tôi mua cái này."], dialoguePrompt: "Buy a souvenir at Dong Ba Market.", imageUrl: "https://placehold.co/600x400/FF6347/FFF?text=Dong+Ba+Market", status: 'locked', performance: null },
            { id: 'alexa_ep7', coords: [16.2000, 108.1333], scenarioTitle: "Hai Van Pass Journey", learningFocus: "Describing views, road trip talk.", keyPhrases: ["Cảnh đẹp tuyệt vời!", "Dừng lại chụp ảnh.", "Đường này có dốc không?"], dialoguePrompt: "Stop at a viewpoint on Hai Van Pass.", imageUrl: "https://placehold.co/600x400/6495ED/FFF?text=Hai+Van+Pass", status: 'locked', performance: null },
            { id: 'alexa_ep8', coords: [15.9970, 108.2630], scenarioTitle: "Marble Mountains (Da Nang)", learningFocus: "Asking about legends, buying souvenirs.", keyPhrases: ["Ngũ Hành Sơn.", "Leo lên hang động.", "Mua đồ lưu niệm."], dialoguePrompt: "Explore a cave in Marble Mountains.", imageUrl: "https://placehold.co/600x400/B0C4DE/000?text=Marble+Mountains", status: 'locked', performance: null },
            { id: 'alexa_ep9', coords: [15.8780, 108.3300], scenarioTitle: "Cooking Class in Hoi An", learningFocus: "Ingredients, cooking steps.", keyPhrases: ["Học nấu ăn.", "Món này làm thế nào?", "Thêm gia vị."], dialoguePrompt: "Participate in a Hoi An cooking class.", imageUrl: "https://placehold.co/600x400/9ACD32/000?text=Hoi+An+Cooking", status: 'locked', performance: null },
            { id: 'alexa_ep10', coords: [15.9110, 108.3648], scenarioTitle: "Beach Relaxation (An Bang)", learningFocus: "Ordering drinks, beach talk.", keyPhrases: ["Cho tôi một quả dừa.", "Biển có sóng không?", "Nước có ấm không?"], dialoguePrompt: "Relax at An Bang beach.", imageUrl: "https://placehold.co/600x400/ADD8E6/000?text=An+Bang+Beach", status: 'locked', performance: null }
        ];

        const brianStoryLessons = [
            { id: 'brian_ep1', coords: [10.0370, 105.7882], scenarioTitle: "Dinner with In-Laws (Can Tho)", learningFocus: "Table manners, family vocab.", keyPhrases: ["Mời cả nhà ăn cơm.", "Món này ngon quá!", "Để con giúp."], dialoguePrompt: "Compliment food with in-laws.", imageUrl: "https://placehold.co/600x400/90EE90/000?text=Family+Dinner", status: 'current', performance: null },
            { id: 'brian_ep2', coords: [10.2380, 106.3760], scenarioTitle: "Orchard Visit (Ben Tre)", learningFocus: "Fruits, farming.", keyPhrases: ["Trái cây này là gì?", "Vườn rộng quá!", "Hái thử được không?"], dialoguePrompt: "Ask about fruits in an orchard.", imageUrl: "https://placehold.co/600x400/FFB6C1/000?text=Ben+Tre+Orchard", status: 'locked', performance: null },
            { id: 'brian_ep3', coords: [9.6038, 105.9720], scenarioTitle: "Local Festival (Soc Trang)", learningFocus: "Festival activities, traditions.", keyPhrases: ["Lễ hội vui quá!", "Đây là truyền thống gì?", "Mọi người làm gì?"], dialoguePrompt: "Ask about festival activities.", imageUrl: "https://placehold.co/600x400/E6E6FA/000?text=Soc+Trang+Festival", status: 'locked', performance: null },
            { id: 'brian_ep4', coords: [10.0452, 105.7468], scenarioTitle: "Cai Rang Floating Market", learningFocus: "Buying goods, boat interactions.", keyPhrases: ["Chợ nổi buổi sáng.", "Bán cho tôi cái này.", "Thuyền của bạn đẹp!"], dialoguePrompt: "Buy something at the floating market.", imageUrl: "https://placehold.co/600x400/F0E68C/000?text=Cai+Rang+Market", status: 'locked', performance: null },
            { id: 'brian_ep5', coords: [10.3500, 105.6000], scenarioTitle: "Visiting Vinh Trang Pagoda (My Tho)", learningFocus: "Religious sites, respect.", keyPhrases: ["Chùa Vĩnh Tràng.", "Thật là trang nghiêm.", "Đi nhẹ, nói khẽ."], dialoguePrompt: "Show respect at Vinh Trang Pagoda.", imageUrl: "https://placehold.co/600x400/FAFAD2/000?text=Vinh+Trang+Pagoda", status: 'locked', performance: null },
            { id: 'brian_ep6', coords: [9.8000, 105.5000], scenarioTitle: "Fishing with Locals (Mekong)", learningFocus: "Fishing terms, daily life.", keyPhrases: ["Đi câu cá.", "Con cá này to quá!", "Cuộc sống ở đây thế nào?"], dialoguePrompt: "Try fishing with a local.", imageUrl: "https://placehold.co/600x400/AFEEEE/000?text=Mekong+Fishing", status: 'locked', performance: null },
            { id: 'brian_ep7', coords: [10.1500, 106.2000], scenarioTitle: "Learning a Folk Song", learningFocus: "Music, cultural expression.", keyPhrases: ["Bài hát này hay quá.", "Dạy tôi hát được không?", "Đàn ca tài tử."], dialoguePrompt: "Ask someone to teach you a folk song.", imageUrl: "https://placehold.co/600x400/DB7093/FFF?text=Folk+Song", status: 'locked', performance: null },
            { id: 'brian_ep8', coords: [10.2400, 106.3800], scenarioTitle: "Making Coconut Candy (Ben Tre)", learningFocus: "Crafts, local products.", keyPhrases: ["Kẹo dừa Bến Tre.", "Làm kẹo này thế nào?", "Tôi muốn thử làm."], dialoguePrompt: "Learn about coconut candy making.", imageUrl: "https://placehold.co/600x400/FFEFD5/000?text=Coconut+Candy", status: 'locked', performance: null },
            { id: 'brian_ep9', coords: [10.0300, 105.7800], scenarioTitle: "Family Anniversary Party (Can Tho)", learningFocus: "Celebrations, giving wishes.", keyPhrases: ["Chúc mừng kỷ niệm!", "Chúc gia đình hạnh phúc.", "Mọi người thật vui vẻ."], dialoguePrompt: "Offer congratulations at a party.", imageUrl: "https://placehold.co/600x400/FFDAB9/000?text=Family+Party", status: 'locked', performance: null },
            { id: 'brian_ep10', coords: [9.9000, 105.7500], scenarioTitle: "A Quiet Evening by the River", learningFocus: "Relaxed conversation, nature.", keyPhrases: ["Buổi tối yên bình.", "Sông Hậu đẹp quá.", "Ngắm trăng."], dialoguePrompt: "Enjoy a peaceful evening chat.", imageUrl: "https://placehold.co/600x400/E0FFFF/000?text=Mekong+Evening", status: 'locked', performance: null }
        ];

        const christineStoryLessons = [
            { id: 'christine_ep1', coords: [16.0545, 108.2208], scenarioTitle: "Business Meeting (Da Nang)", learningFocus: "Formal intros, business cards.", keyPhrases: ["Rất vui được gặp anh/chị.", "Đây là danh thiếp của tôi.", "Thảo luận về dự án."], dialoguePrompt: "Introduce yourself formally.", imageUrl: "https://placehold.co/600x400/B0E0E6/000?text=Da+Nang+Meeting", status: 'current', performance: null },
            { id: 'christine_ep2', coords: [15.7731, 108.2905], scenarioTitle: "Historical Research (My Son)", learningFocus: "Detailed history, architecture.", keyPhrases: ["Di tích này bao nhiêu tuổi?", "Kiến trúc này ý nghĩa gì?", "Nghiên cứu văn hóa Chăm."], dialoguePrompt: "Ask about Cham architecture.", imageUrl: "https://placehold.co/600x400/FFE4B5/000?text=My+Son+Research", status: 'locked', performance: null },
            { id: 'christine_ep3', coords: [12.6675, 108.0470], scenarioTitle: "Coffee Highlands (Buon Ma Thuot)", learningFocus: "Coffee production, tasting.", keyPhrases: ["Cà phê ở đây nổi tiếng.", "Quy trình trồng cà phê?", "Thử cà phê chồn."], dialoguePrompt: "Ask about coffee making.", imageUrl: "https://placehold.co/600x400/D2B48C/FFF?text=Coffee+Plantation", status: 'locked', performance: null },
            { id: 'christine_ep4', coords: [16.0620, 108.2240], scenarioTitle: "Cham Museum Visit (Da Nang)", learningFocus: "Artifacts, historical periods.", keyPhrases: ["Bảo tàng Chăm.", "Hiện vật này từ thế kỷ nào?", "Rất ấn tượng."], dialoguePrompt: "Discuss an artifact at Cham Museum.", imageUrl: "https://placehold.co/600x400/F08080/FFF?text=Cham+Museum", status: 'locked', performance: null },
            { id: 'christine_ep5', coords: [16.1950, 107.8500], scenarioTitle: "Eco-Tourism Project (Bach Ma)", learningFocus: "Environment, sustainability.", keyPhrases: ["Vườn quốc gia Bạch Mã.", "Bảo vệ môi trường.", "Du lịch sinh thái bền vững."], dialoguePrompt: "Discuss an eco-project.", imageUrl: "https://placehold.co/600x400/98FB98/000?text=Bach+Ma+Park", status: 'locked', performance: null },
            { id: 'christine_ep6', coords: [15.8770, 108.3280], scenarioTitle: "Market Survey (Hoi An)", learningFocus: "Market research, suppliers.", keyPhrases: ["Khảo sát thị trường.", "Nguồn cung cấp ở đâu?", "Giá cả hợp lý."], dialoguePrompt: "Conduct a market survey.", imageUrl: "https://placehold.co/600x400/FFDEAD/000?text=Hoi+An+Market", status: 'locked', performance: null },
            { id: 'christine_ep7', coords: [16.4600, 107.5800], scenarioTitle: "Presenting Findings (Hue)", learningFocus: "Formal presentation, Q&A.", keyPhrases: ["Trình bày kết quả.", "Số liệu cho thấy...", "Có câu hỏi nào không?"], dialoguePrompt: "Present research findings.", imageUrl: "https://placehold.co/600x400/E0FFFF/000?text=Hue+Presentation", status: 'locked', performance: null },
            { id: 'christine_ep8', coords: [12.2450, 109.1900], scenarioTitle: "Networking Event (Nha Trang)", learningFocus: "Small talk, professional intros.", keyPhrases: ["Rất hân hạnh.", "Công ty của bạn làm gì?", "Chúng ta có thể hợp tác."], dialoguePrompt: "Network at an event.", imageUrl: "https://placehold.co/600x400/FFFACD/000?text=Nha+Trang+Event", status: 'locked', performance: null },
            { id: 'christine_ep9', coords: [10.8231, 106.6297], scenarioTitle: "Factory Visit (HCMC Outskirts)", learningFocus: "Production process, quality control.", keyPhrases: ["Tham quan nhà máy.", "Quy trình sản xuất.", "Kiểm tra chất lượng."], dialoguePrompt: "Ask about factory production.", imageUrl: "https://placehold.co/600x400/DCDCDC/000?text=Factory+Visit", status: 'locked', performance: null },
            { id: 'christine_ep10', coords: [16.0700, 108.2200], scenarioTitle: "Contract Finalization (Da Nang)", learningFocus: "Legal terms, signing.", keyPhrases: ["Xem lại hợp đồng.", "Điều khoản thanh toán.", "Ký kết thỏa thuận."], dialoguePrompt: "Discuss final contract terms.", imageUrl: "https://placehold.co/600x400/ADD8E6/000?text=Contract+Signing", status: 'locked', performance: null }
        ];
        
        const davidStoryLessons = [
            { id: 'david_ep1', coords: [21.0060, 105.8430], scenarioTitle: "Uni Campus Life (Hanoi)", learningFocus: "Student life, classes, plans.", keyPhrases: ["Bạn học ngành gì?", "Lớp này khó không?", "Tối nay đi chơi?"], dialoguePrompt: "Chat with a classmate.", imageUrl: "https://placehold.co/600x400/FFC0CB/000?text=Hanoi+Uni", status: 'current', performance: null },
            { id: 'david_ep2', coords: [23.0663, 105.2832], scenarioTitle: "Planning Ha Giang Loop", learningFocus: "Routes, safety, guesthouses.", keyPhrases: ["Đi đường nào?", "Có nguy hiểm không?", "Đặt phòng nhà nghỉ."], dialoguePrompt: "Plan Ha Giang Loop with friends.", imageUrl: "https://placehold.co/600x400/87CEFA/000?text=Ha+Giang+Plan", status: 'locked', performance: null },
            { id: 'david_ep3', coords: [22.4075, 105.6188], scenarioTitle: "Adventure at Ba Be Lake", learningFocus: "Nature, boating, flora/fauna.", keyPhrases: ["Hồ Ba Bể đẹp quá!", "Thuê thuyền đi dạo.", "Con vật kia là gì?"], dialoguePrompt: "Ask boat guide about nature.", imageUrl: "https://placehold.co/600x400/98FB98/000?text=Ba+Be+Lake", status: 'locked', performance: null },
            { id: 'david_ep4', coords: [21.0350, 105.8480], scenarioTitle: "Street Food Tour (Hanoi)", learningFocus: "Ordering street foods, ingredients.", keyPhrases: ["Bún chả ở đâu ngon?", "Món này cay không?", "Cho thêm rau thơm."], dialoguePrompt: "Try a new street food.", imageUrl: "https://placehold.co/600x400/FFA500/000?text=Hanoi+Street+Food", status: 'locked', performance: null },
            { id: 'david_ep5', coords: [22.0000, 104.5000], scenarioTitle: "Volunteering (Rural North)", learningFocus: "Teaching English, interacting.", keyPhrases: ["Dạy tiếng Anh.", "Các em học giỏi quá!", "Cùng nhau chơi nhé."], dialoguePrompt: "Interact with local children.", imageUrl: "https://placehold.co/600x400/FFD700/000?text=Rural+Volunteering", status: 'locked', performance: null },
            { id: 'david_ep6', coords: [22.5390, 104.2890], scenarioTitle: "Ethnic Market (Bac Ha)", learningFocus: "Observing customs, local products.", keyPhrases: ["Chợ phiên Bắc Hà.", "Vải thổ cẩm đẹp quá!", "Mua một ít làm quà."], dialoguePrompt: "Buy a local handicraft.", imageUrl: "https://placehold.co/600x400/DA70D6/FFF?text=Bac+Ha+Market", status: 'locked', performance: null },
            { id: 'david_ep7', coords: [21.8400, 104.1200], scenarioTitle: "Photography (Mu Cang Chai)", learningFocus: "Landscapes, photography terms.", keyPhrases: ["Ruộng bậc thang.", "Chụp ảnh lúc bình minh.", "Góc này đẹp!"], dialoguePrompt: "Take photos of rice terraces.", imageUrl: "https://placehold.co/600x400/32CD32/FFF?text=Mu+Cang+Chai", status: 'locked', performance: null },
            { id: 'david_ep8', coords: [21.0300, 105.8530], scenarioTitle: "Water Puppet Show (Hanoi)", learningFocus: "Understanding show, tickets.", keyPhrases: ["Múa rối nước.", "Mua vé ở đâu?", "Hay quá!"], dialoguePrompt: "Watch a water puppet show.", imageUrl: "https://placehold.co/600x400/8A2BE2/FFF?text=Water+Puppets", status: 'locked', performance: null },
            { id: 'david_ep9', coords: [20.9700, 105.9000], scenarioTitle: "Pottery Village (Bat Trang)", learningFocus: "Traditional crafts, techniques.", keyPhrases: ["Làng gốm Bát Tràng.", "Thử nặn gốm.", "Hoa văn này ý nghĩa gì?"], dialoguePrompt: "Try making pottery.", imageUrl: "https://placehold.co/600x400/A52A2A/FFF?text=Bat+Trang+Pottery", status: 'locked', performance: null },
            { id: 'david_ep10', coords: [21.0280, 105.8500], scenarioTitle: "Farewell Party (Hanoi)", learningFocus: "Saying goodbye, future plans.", keyPhrases: ["Tạm biệt các bạn.", "Hẹn gặp lại.", "Chúc may mắn!"], dialoguePrompt: "Say farewell to friends.", imageUrl: "https://placehold.co/600x400/FF69B4/FFF?text=Hanoi+Farewell", status: 'locked', performance: null }
        ];

        const storyData = [
            { id: 'story1', title: 'Alexa', subtitle: 'Tourist story', episodesCompleted: 5, totalEpisodes: alexaStoryLessons.length, backgroundImageUrl: 'https://placehold.co/300x400/7DD3FC/FFF?text=Story+Alexa', lessons: alexaStoryLessons },
            { id: 'story2', title: 'Brian', subtitle: 'Married by Vietnamese', episodesCompleted: 8, totalEpisodes: brianStoryLessons.length, backgroundImageUrl: 'https://placehold.co/300x400/FDBA74/FFF?text=Story+Brian', lessons: brianStoryLessons }, 
            { id: 'story3', title: 'Christine', subtitle: 'Intermediate', episodesCompleted: 3, totalEpisodes: christineStoryLessons.length, backgroundImageUrl: 'https://placehold.co/300x400/ECFCCB/000?text=Story+Christine', lessons: christineStoryLessons },
            { id: 'story4', title: 'David', subtitle: 'Student', episodesCompleted: 7, totalEpisodes: davidStoryLessons.length, backgroundImageUrl: 'https://placehold.co/300x400/A5B4FC/FFF?text=Story+David', lessons: davidStoryLessons },
        ];

        let map; 
        const infoPanel = document.getElementById('info-panel');
        const panelHeader = document.getElementById('info-panel-header'); 
        const dragHandle = document.getElementById('drag-handle'); 
        const panelTitleElement = document.getElementById('panel-title'); 
        const infoContentWrapper = document.getElementById('info-content-wrapper'); 
        const infoContent = document.getElementById('info-content');
        const closePanelBtn = document.getElementById('close-panel-btn');
        const prevLocationBtn = document.getElementById('prev-location-btn');
        const nextLocationBtn = document.getElementById('next-location-btn');
        const currentLocationIndicator = document.getElementById('current-location-indicator');

        let markers = []; 
        let latLngs = []; 
        let selectedMarker = null;
        let currentLocationIndex = -1; 
        let activeStoryLessons = []; 
        let mapMarkersLayerGroup = null; 

        const starFilledSVG = `<svg class="star-filled" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"></path></svg>`;
        const starEmptySVG = `<svg class="star-empty" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M10 12a2 2 0 100-4 2 2 0 000 4zm0-6a6 6 0 100 12 6 6 0 000-12zm0 1a8 8 0 100 16A8 8 0 0010 2z" clip-rule="evenodd"></path></svg>`;
        const lockSVG = `<svg class="lock-icon" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd"></path></svg>`;
        const chevronDownSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" /></svg>`;
        const chevronUpSVG = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-7 h-7"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 15.75l7.5-7.5 7.5 7.5" /></svg>`;

        function createLocationIcon(number, isSelected = false, status = 'locked', performance = null) {
            const size = isSelected ? 40 : 30;
            const anchor = isSelected ? [20, 40] : [15, 30];
            let iconHtml = '';
            let statusClassName = '';
            let baseFontSize = '12px'; 
            let selectedFontSize = '16px';
            let checkmarkBaseFontSize = '16px';
            let checkmarkSelectedFontSize = '20px';

            switch (status) {
                case 'locked':
                    statusClassName = 'status-locked-upcoming';
                    iconHtml = `<span style="font-size: ${isSelected ? selectedFontSize : baseFontSize}; line-height: ${size}px; color: #E2E8F0;">${number}</span>`;
                    break;
                case 'completed':
                    iconHtml = `<span style="font-size: ${isSelected ? checkmarkSelectedFontSize : checkmarkBaseFontSize}; line-height: ${size}px;">✓</span>`;
                    switch (performance) {
                        case 'gold': statusClassName = 'status-completed-gold'; break;
                        case 'silver': statusClassName = 'status-completed-silver'; break;
                        case 'bronze': statusClassName = 'status-completed-bronze'; break;
                        default: statusClassName = 'status-completed-base'; break;
                    }
                    break;
                case 'current':
                default:
                    statusClassName = 'status-current';
                    iconHtml = `<span style="font-size: ${isSelected ? selectedFontSize : baseFontSize}; line-height: ${size}px;">${number}</span>`;
                    break;
            }
            return L.divIcon({ className: `custom-marker-icon ${statusClassName}`, html: iconHtml, iconSize: [size, size], iconAnchor: anchor, popupAnchor: [0, -(size - 2)] });
        }
        
        function getStatusIndicatorHTML(status, performance) {
            let indicatorHTML = '<div class="status-indicator-container">';
            const maxStars = 3;
            if (status === 'completed') {
                let filledStars = 0;
                switch (performance) {
                    case 'gold': filledStars = 3; break;
                    case 'silver': filledStars = 2; break;
                    case 'bronze': filledStars = 1; break;
                    default: filledStars = 0; 
                }
                for (let i = 0; i < filledStars; i++) indicatorHTML += starFilledSVG;
                for (let i = filledStars; i < maxStars; i++) indicatorHTML += starEmptySVG;
            } else if (status === 'current') {
                indicatorHTML += `<button id="start-lesson-action-button" class="start-lesson-button">START LESSON</button>`;
            } else if (status === 'locked') {
                indicatorHTML += lockSVG;
            }
            indicatorHTML += '</div>';
            return indicatorHTML;
        }

        function updateNavigationControls() {
            if (currentLocationIndex === -1 || activeStoryLessons.length === 0) {
                prevLocationBtn.disabled = true;
                nextLocationBtn.disabled = true;
                currentLocationIndicator.textContent = `0 / ${activeStoryLessons.length}`;
                return;
            }
            prevLocationBtn.disabled = currentLocationIndex === 0;
            nextLocationBtn.disabled = currentLocationIndex >= activeStoryLessons.length - 1;
            currentLocationIndicator.textContent = `${currentLocationIndex + 1} / ${activeStoryLessons.length}`;
        }

        function displayLocationDetails(indexToShow) {
            if (!activeStoryLessons || indexToShow < 0 || indexToShow >= activeStoryLessons.length) return;

            if (selectedMarker) {
                 const prevMarkerArrayIndex = markers.indexOf(selectedMarker);
                 if (prevMarkerArrayIndex !== -1 && activeStoryLessons[prevMarkerArrayIndex]) { 
                    const prevScenario = activeStoryLessons[prevMarkerArrayIndex];
                    markers[prevMarkerArrayIndex].setIcon(createLocationIcon(prevMarkerArrayIndex + 1, false, prevScenario.status, prevScenario.performance));
                 }
            }
            
            currentLocationIndex = indexToShow;
            const scenario = activeStoryLessons[currentLocationIndex];
            const currentMapMarker = markers[currentLocationIndex];

            if (!scenario || !currentMapMarker) return; 

            currentMapMarker.setIcon(createLocationIcon(currentLocationIndex + 1, true, scenario.status, scenario.performance));
            selectedMarker = currentMapMarker;

            panelTitleElement.textContent = scenario.scenarioTitle; 
            let phrasesHTML = scenario.keyPhrases.map(phrase => `<li>${phrase}</li>`).join('');
            const statusIndicatorHTML = getStatusIndicatorHTML(scenario.status, scenario.performance);
            const imageGrayscaleClass = (scenario.status === 'locked' || scenario.status === 'current') ? 'grayscale' : '';

            infoContent.innerHTML = `
                <img src="${scenario.imageUrl}" alt="${scenario.scenarioTitle}" class="w-full object-cover rounded-lg shadow ${imageGrayscaleClass}" onerror="this.src='https://placehold.co/600x400/CCCCCC/FFF?text=Scenario+Image'; this.onerror=null;">
                ${statusIndicatorHTML} 
                <h3 class="key-phrases-title">Learning Focus:</h3>
                <p class="scenario-description">${scenario.learningFocus}</p>
                <h3 class="key-phrases-title">Key Phrases:</h3>
                <ul class="key-phrases-list">${phrasesHTML}</ul>
                <h3 class="key-phrases-title">Try this:</h3>
                <p class="scenario-description">${scenario.dialoguePrompt}</p>
            `;
            infoContentWrapper.style.display = 'block'; 

            const startButton = document.getElementById('start-lesson-action-button');
            if (startButton) {
                startButton.addEventListener('click', () => {
                    console.log(`Starting lesson: ${scenario.scenarioTitle}`);
                    if (scenario.status === 'current') {
                        scenario.status = 'completed';
                        scenario.performance = 'bronze'; 
                        markers[currentLocationIndex].setIcon(createLocationIcon(currentLocationIndex + 1, true, scenario.status, scenario.performance));
                        
                        const newStatusIndicatorHTML = getStatusIndicatorHTML(scenario.status, scenario.performance);
                        const indicatorDiv = infoContent.querySelector('.status-indicator-container');
                        if (indicatorDiv) indicatorDiv.innerHTML = newStatusIndicatorHTML.match(/<div class="status-indicator-container">(.*)<\/div>/)[1];

                        const nextScenarioIndex = currentLocationIndex + 1;
                        if (nextScenarioIndex < activeStoryLessons.length && activeStoryLessons[nextScenarioIndex].status === 'locked') {
                            activeStoryLessons[nextScenarioIndex].status = 'current';
                             markers[nextScenarioIndex].setIcon(createLocationIcon(nextScenarioIndex + 1, false, 'current', null));
                        }
                        updateNavigationControls(); 
                        if (nextScenarioIndex < activeStoryLessons.length) {
                            setTimeout(() => displayLocationDetails(nextScenarioIndex), 500);
                        } else { 
                            collapseInfoPanel();
                        }
                    }
                });
            }
            
            const panelWasHiddenOrCollapsed = !infoPanel.classList.contains('expanded') || infoPanel.style.transform === 'translateY(100%)';
            
            infoPanel.classList.remove('hidden-fully', 'collapsed'); 
            infoPanel.classList.add('expanded');
            infoPanel.style.transform = ''; 
            closePanelBtn.innerHTML = chevronDownSVG; 
            updateNavigationControls();

            const panelExpansionHandler = (event) => {
                if (event.propertyName === 'transform' && infoPanel.classList.contains('expanded')) {
                    infoPanel.removeEventListener('transitionend', panelExpansionHandler); 
                    const targetZoom = 11; 
                    const panelHeightForOffset = window.innerHeight * 0.60; 
                    const yOffset = panelHeightForOffset / 2;
                    const projectedLocation = map.project(scenario.coords, targetZoom);
                    const projectedCenter = L.point(projectedLocation.x, projectedLocation.y + yOffset);
                    const targetLatLng = map.unproject(projectedCenter, targetZoom);
                    map.flyTo(targetLatLng, targetZoom, { duration: 5.0 });
                }
            };
            
            if (panelWasHiddenOrCollapsed) {
                infoPanel.addEventListener('transitionend', panelExpansionHandler);
            } else { 
                const targetZoom = 11;
                const panelHeightForOffset = window.innerHeight * 0.60;
                const yOffset = panelHeightForOffset / 2;
                const projectedLocation = map.project(scenario.coords, targetZoom);
                const projectedCenter = L.point(projectedLocation.x, projectedLocation.y + yOffset);
                const targetLatLng = map.unproject(projectedCenter, targetZoom);
                map.flyTo(targetLatLng, targetZoom, { duration: 5.0 });
            }
        }
        
        function setupMapInstance() { 
            if (!map) { 
                map = L.map('map', { zoomControl: false }).setView([16.0, 108.0], 5);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                    subdomains: 'abcd', maxZoom: 19 
                }).addTo(map);
                L.control.zoom({ position: 'topright' }).addTo(map);
                mapMarkersLayerGroup = L.layerGroup().addTo(map);
                map.on('click', () => { 
                    if (map && infoPanel.classList.contains('expanded')) { 
                        collapseInfoPanel();
                    }
                });
                mapInitialized = true;
            }
        }

        function loadStoryOnMap() {
            setupMapInstance(); 

            mapMarkersLayerGroup.clearLayers(); 
            markers.length = 0;
            latLngs.length = 0;
            selectedMarker = null; 

            if (!activeStoryLessons || activeStoryLessons.length === 0) {
                console.warn("No active learning scenarios for this story.");
                map.setView([16.0, 108.0], 5); 
                currentLocationIndex = -1;
                collapseInfoPanel(); 
                updateNavigationControls();
                panelTitleElement.textContent = "Scenario Details";
                infoContent.innerHTML = `<p class="text-gray-600">No lessons in this story yet. Choose another story!</p>`;
                return;
            }

            activeStoryLessons.forEach((scenario, index) => {
                const marker = L.marker(scenario.coords, { icon: createLocationIcon(index + 1, false, scenario.status, scenario.performance) })
                    .on('click', (e) => {
                        L.DomEvent.stopPropagation(e);
                        displayLocationDetails(index);
                    });
                markers.push(marker);
                latLngs.push(scenario.coords);
                mapMarkersLayerGroup.addLayer(marker);
            });

            if (latLngs.length > 0) {
                const bounds = L.latLngBounds(latLngs);
                map.fitBounds(bounds.pad(0.15)); 
            }
            
            let initialIndexForStory = activeStoryLessons.findIndex(s => s.status === 'current');
            if (initialIndexForStory === -1 && activeStoryLessons.length > 0) {
                initialIndexForStory = 0; 
                activeStoryLessons[0].status = 'current'; 
                 markers[0].setIcon(createLocationIcon(1, false, 'current', null)); 
            }
            currentLocationIndex = initialIndexForStory !== -1 ? initialIndexForStory : -1;

            collapseInfoPanel(); 
            updateNavigationControls();
        }


        function collapseInfoPanel() { 
            infoPanel.style.transform = ''; 
            infoPanel.classList.remove('expanded', 'hidden-fully');
            infoPanel.classList.add('collapsed');
            infoContentWrapper.style.display = 'none';
            closePanelBtn.innerHTML = chevronUpSVG; 

            if (selectedMarker) {
                const prevMarkerIndex = markers.indexOf(selectedMarker);
                if (prevMarkerIndex !== -1 && activeStoryLessons[prevMarkerIndex]) {
                    const prevScenario = activeStoryLessons[prevMarkerIndex];
                    markers[prevMarkerIndex].setIcon(createLocationIcon(prevMarkerIndex + 1, false, prevScenario.status, prevScenario.performance));
                }
                selectedMarker = null; 
            }
        }

        function expandInfoPanel() {
            infoPanel.style.transform = ''; 
            if (infoPanel.classList.contains('collapsed') && currentLocationIndex !== -1) {
                displayLocationDetails(currentLocationIndex); 
            } else if ((infoPanel.classList.contains('hidden-fully') || !infoPanel.classList.contains('expanded')) && currentLocationIndex === -1 && activeStoryLessons.length > 0) {
                let initialIndexToOpen = activeStoryLessons.findIndex(s => s.status === 'current');
                if (initialIndexToOpen === -1 && activeStoryLessons.length > 0) initialIndexToOpen = 0; 
                if (initialIndexToOpen !== -1) displayLocationDetails(initialIndexToOpen);
            } else if (infoPanel.classList.contains('hidden-fully')) { 
                 infoPanel.classList.remove('hidden-fully','expanded');
                 infoPanel.classList.add('collapsed');
                 infoContentWrapper.style.display = 'none';
                 closePanelBtn.innerHTML = chevronUpSVG;
            }
        }
        
        const navItems = document.querySelectorAll('.nav-item');
        const pages = document.querySelectorAll('.page');
        let mapPageFirstLoad = true;
        const mapNavItem = document.querySelector('.nav-item[data-page="map-page-content"]'); // Get map nav item


        function switchPage(pageId) {
            pages.forEach(page => page.classList.remove('active-page'));
            document.getElementById(pageId).classList.add('active-page');
            
            navItems.forEach(item => {
                item.classList.remove('active-nav-item');
                if (item.dataset.page === pageId) item.classList.add('active-nav-item');
            });

            if (pageId === 'map-page-content') {
                setupMapInstance(); 
                setTimeout(() => { 
                    map.invalidateSize();
                    if (mapPageFirstLoad || !activeStoryLessons || activeStoryLessons.length === 0) { 
                        loadStoryOnMap(); 
                        mapPageFirstLoad = false; 
                    } else {
                         if (infoPanel.classList.contains('expanded')) {
                            closePanelBtn.innerHTML = chevronDownSVG;
                        } else {
                            collapseInfoPanel(); 
                        }
                    }
                }, 0);
                infoPanel.classList.remove('hidden-fully'); 
            } else {
                infoPanel.classList.remove('expanded', 'collapsed');
                infoPanel.classList.add('hidden-fully'); 
            }
        }

        function renderStoryCards() {
            const gridContainer = document.getElementById('stories-grid-container');
            if (!gridContainer) return;
            gridContainer.innerHTML = ''; 

            storyData.forEach(story => {
                const card = document.createElement('div');
                card.className = 'story-card';
                const progressPercentage = story.totalEpisodes > 0 ? (story.episodesCompleted / story.totalEpisodes) * 100 : 0;
                
                card.innerHTML = `
                    <img src="${story.backgroundImageUrl}" alt="${story.title}" class="story-card-image" onerror="this.src='https://placehold.co/300x400/CCCCCC/FFF?text=Image+Error'; this.onerror=null;">
                    <div class="story-card-overlay">
                        <h3 class="card-title">${story.title}</h3>
                        <p class="card-subtitle">${story.subtitle}</p>
                        <p class="card-episodes-text">${story.totalEpisodes} episodes</p>
                        <div class="progress-bar-container">
                            <div class="progress-bar-fill" style="width: ${progressPercentage}%;"></div>
                        </div>
                    </div>
                `;
                card.addEventListener('click', () => {
                    console.log(`Story selected: ${story.title}`);
                    activeStoryLessons = story.lessons || [];
                    mapPageFirstLoad = true; 
                    if (mapNavItem) mapNavItem.classList.remove('nav-item-disabled'); // Enable map nav item
                    switchPage('map-page-content');
                });
                gridContainer.appendChild(card);
            });
        }

        navItems.forEach(item => item.addEventListener('click', () => {
            if (item.classList.contains('nav-item-disabled')) return; // Prevent click if disabled
            switchPage(item.dataset.page);
        }));
        
        switchPage('stories-page-content'); 
        renderStoryCards(); 
        if (mapNavItem) mapNavItem.classList.add('nav-item-disabled'); // Disable map nav item initially


        closePanelBtn.addEventListener('click', (e) => {
            L.DomEvent.stopPropagation(e);
            if (infoPanel.classList.contains('expanded')) collapseInfoPanel();
            else if (infoPanel.classList.contains('collapsed')) expandInfoPanel();
        });

        dragHandle.addEventListener('click', expandInfoPanel);
        panelHeader.addEventListener('click', (e) => {
            if (e.target === panelHeader || e.target === panelTitleElement) {
                if (infoPanel.classList.contains('collapsed')) expandInfoPanel();
            }
        });

        prevLocationBtn.addEventListener('click', () => {
            if (currentLocationIndex > 0) displayLocationDetails(currentLocationIndex - 1);
        });
        nextLocationBtn.addEventListener('click', () => {
            if (currentLocationIndex < activeStoryLessons.length - 1) displayLocationDetails(currentLocationIndex + 1);
        });
        
        L.DomEvent.disableClickPropagation(infoPanel);
        window.addEventListener('resize', () => { if (map) map.invalidateSize(); });

    </script>
</body>
</html>
